

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
   <title>ניתוח מבנים להתחדשות עירונית</title>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta
   name="viewport"
   content="width = device-width,
              initial-scale = 1"/>

 <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
 <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
 <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
 <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">


</head>
<body scrolling='no' dir="rtl">

   <div id="app" style="height: 800px;"  >


 
       <v-app v-cloak right style='background-image: linear-gradient(to bottom right, #FAFAFA ,  #BBDEFB); opacity: 90%;'>
         <v-main>


           <v-container>
   
               <v-system-bar>
               </v-system-bar>

    

               
     
               <v-app-bar color="rgba(255, 255, 255, 0.8)" justify="space-around">

     


               <v-dialog
               v-model="dialog"
               max-width="500px"
             >
               <v-card>
                 <v-card-title>
                   <span >אפשרויות סינון</span>
                 </v-card-title>
     
                 <v-card-text>
                   <v-container>
                     <v-row>
                       <v-col
                         cols="12"
                         sm="6"
                         md="6"
                       >

                     <v-text-field
                       v-model="min_year"
                       label="משנת בניה"
                       type="number"
                       :rules="minyear_rules"
                       />
                       </v-col>
                       <v-col
                         cols="12"
                         sm="6"
                         md="6"
                       >


                     <v-text-field
                     v-model="max_year"
                     label="עד שנת בניה"
                     type="number"
                     :rules="maxyear_rules"
                     />
                       </v-col>

                       <v-col
                         cols="12"
                         sm="6"
                         md="6"
                       >
                       <v-select
                       :items="[1,2,3,4,5,6,7,8,9,10]"
                       label="ממספר קומות"
                       v-model="min_floor"
                     ></v-select>
                       </v-col>
                       <v-col
                         cols="12"
                         sm="6"
                         md="6"
                       >
                         <v-select
                         :items="[1,2,3,4,5,6,7,8,9,10]"
                           label="עד מספר קומות"
                           v-model="max_floor"
                         ></v-select>
                       </v-col>
        
                     </v-row>
                   </v-container>
                 </v-card-text>
     
                 <v-card-actions>
                   <v-spacer></v-spacer>
                   <v-btn
                     color="blue darken-1"
                     text
                     @click="close"
                   >
                     ביטול
                   </v-btn>
                   <v-btn
                     color="blue darken-1"
                     text
                     @click="save"
                   >
                     אישור
                   </v-btn>
                 </v-card-actions>
               </v-card>
             </v-dialog>
     

     
             <div v-if="mobile" style="margin-top: 17px; font-size: small;"><p> <v-badge
               color="red"
               :content="selected_features.length"
               :value="badge"
             >ניתוח מבנים להתחדשות עירונית </v-badge></p></div>


               <div v-else style="margin-top: 17px; font-size: large;"><p> ניתוח מבנים להתחדשות עירונית </p></div>


                 <v-chip v-if="!mobile" v-show="selected_features.length > 0"
                   class="ma-2"
                   color="red"
                   text-color="white"
                   >
                   {{selected_features.length}} מבנים נבחרו
                   </v-chip>

   
     
             <v-spacer></v-spacer>



             <v-icon color="red lighten-1" v-show="selected" @click="clear">
               mdi-close-circle
             </v-icon>
          
              

               <v-divider
               class="mx-4"
               inset
               vertical
             ></v-divider>


             <v-btn
       class="ma-2"
       color="grey lighten-1"
       dark
       v-show="selected" @click="dialog=true"
     >
       <v-icon dark >
           mdi-menu
       </v-icon>
     </v-btn>
            

               <v-autocomplete
               v-model="selected"
               :items="options"
               dense
               label="שם ישוב"
             class="mx-4"
             flat
             hide-no-data
             hide-details
             style="max-width: 200px;"
             @change='onChange'


             ></v-autocomplete>
     
   
               
               
     
               </v-app-bar>


                   
                   <v-card
                     class="mx-auto"
                     style = "margin-top: 17px;"

                   >
                           <div id="map" style="height:600px"></div>

                   </v-card>


          



           <v-card v-show="selected_features.length > 0" style="bottom: 0; margin-top: 17px; ">
               <v-card-title>
                 <v-text-field
                   v-model="search"
                   append-icon="mdi-magnify"
                   label="Search"
                   single-line
                   hide-details
                 ></v-text-field>
               </v-card-title>
               <v-layout id="table-v-layout" column style="max-height: 60vh">       
                   <v-flex style="overflow: auto;">

               <v-data-table 
                 style="cursor: pointer"
                 height="400"
                 fixed-header
                 @click:row="handleClick"
                 :headers="headers"
                 sort-by="STR_NAME"
                 :items="selected_features"
                 :search="search"
                 :loading="myloadingvariable" 
                 loading-text="טוען נתונים..."
                 item-key="UNIQ_ID"
                 :page.sync="page"
                 :items-per-page="itemsPerPage"
                 hide-default-footer
                 class="elevation-1"
                 @page-count="pageCount = $event">

   

                 <template v-slot:item.action="{ item }">
                   <v-icon
                     color="blue"
                     @click="openStreetView(item)"
                   >
                   mdi-earth-box
                   </v-icon>
                 </template>


               </v-data-table>
               </v-flex>
           </v-layout>
               <div class="text-center pt-2">
                   <v-pagination
                     v-model="page"
                     :length="pageCount"
                   ></v-pagination>
                   <v-text-field
                     :value="itemsPerPage"
                     label="Items per page"
                     type="number"
                     min="-1"
                     max="15"
                     @input="itemsPerPage = parseInt($event, 10)"
                   ></v-text-field>
                 </div>
             </v-card>



             <div class="text-center">
              <v-dialog
                v-model="gsv_dialog"
                width="500"
              >
          
                <v-card>
                  <v-system-bar>
                    {{addr}}
                    <v-spacer></v-spacer>
                    <v-btn
                    color="black"
                    text
                    @click="gsv_dialog = false"
                  >
                    X
                  </v-btn>
                  </v-system-bar>
          
  
                  <v-divider></v-divider>

                  <div class="d-flex flex-no-wrap justify-space-between">

                  <iframe id="ifrm" ref="ifrm"
                  width="500"
                  height="500"
                  style="border:0"
                  loading="lazy"
                  allowfullscreen
                  :src="strviewUrl">
                </iframe>
                  </div>
          

                </v-card>
              </v-dialog>
            </div>



             <v-snackbar
             v-model="snackbar"
           >
             לא נמצאו מבנים לחיפוש המבוקש
       
           </v-snackbar>


           <v-snackbar
           v-model="strview_snackbar"
         >
           לא נמצאו תמונות לכתובת המבוקשת
     
         </v-snackbar>

           </v-container>

         </v-main>
       </v-app>
     </div>








   <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
   <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
   <script src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
   <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
   <script>

JSITM = {};

/**************************************************************/

/**
 * Creates a new LatLng.
 * 
 * @class holds geographic coordinates measured in degrees.<br/>
 * <a href="http://en.wikipedia.org/wiki/Geographic_coordinate">http://en.wikipedia.org/wiki/Geographic_coordinate</a>
 *
 * @constructor
 * @param {Number} lat latitude in degrees ( http://en.wikipedia.org/wiki/Latitude )
 * @param {Number} lng longtitude in degrees ( http://en.wikipedia.org/wiki/Longitude )
 * @param {Number} alt altitude in meters above the uesd geoid surface - this was not used or tested - please keep this always 0.
 * @param {Number} precision number of digits after the decimal point, used in printout. see toString().
 */
JSITM.LatLng = function(lat, lng, alt, precision){
    this.lat = lat;
    this.lng = lng;
    this.alt = alt || 0;
    this.precision = precision || 5;
}

/**
 * Returns Latlng as string, using the defined preccision
 * @return {String}
 */
JSITM.LatLng.prototype.toString = function(){

    function round(n, precision){
        var m = Math.pow(10, precision || 0);
        return Math.round(n * m) / m;
    }
    
    return round(this.lat, this.precision) + " " + round(this.lng, this.precision);
}

/**
 * Creates a new LatLng by converting coordinates from a source ellipsoid to a target one. <p>
 * This process involves:<p>
 *   1. converting the angular latlng to cartesian coordinates using latLngToPoint()<p>
 *   2. translating the XYZ coordinates using a translation, with special values supplied to this translation.<p>
 *   3. converting the translated XYZ coords back to a new angular LatLng<p>
 *<p>
 *  for example refer to {@link JSITM.itm2gps}
 *
 * @param {JSITM.Ellipsoid} from source elli
 * @param {JSITM.Ellipsoid} to
 * @param {JSITM.Translation} translation
 * @return {JSITM.LatLng}
 */
JSITM.LatLng.prototype.convertGrid = function(from, to, translation){

    var point = from.latLngToPoint(this, 0);
    
    //removed 7 point Helmert translation (not needed in Israel's grids)
    var translated = translation.translate(point);
    
    return to.pointToLatLng(translated);
}

/**
 * Parses latitude and longtitude in a string into a new Latlng
 * @param {String} s
 * @return {JSITM.LatLng}
 */
JSITM.latlngFromString = function(s) {
    var pattern = new RegExp("^(-?\\d+(?:\\.\\d*)?)(?:(?:\\s*[:,]?\\s*)|\\s+)(-?\\d+(?:\\.\\d*)?)$", "i")
    var latlng = s.match(pattern);
    if (latlng) {
        var lat = parseFloat(latlng[1], 10);
        var lng = parseFloat(latlng[2], 10);
        return new JSITM.LatLng(lat, lng);
    }

	throw ("could not parse latlng")
}

/**************************************************************/

/**
 * Creates a new Point.
 * @class holds 2D/3D cartesian coordinates.
 * 
 * @constructor
 * @param {Number} x
 * @param {Number} y
 * @param {Number} z
 * @return {JSITM.Point}
 */
JSITM.Point = function(x, y, z){
    this.y = y;
    this.x = x;
    this.z = z || 0;
}

/**
 * Returns a string containing the Point coordinates in meters
 * @return {String}
 */
JSITM.Point.prototype.toString = function(){
	
    return Math.round(this.x) + " " + Math.round(this.y);
}


/**************************************************************/

/**
 * Creates a new Translation.
 * <p>
 * (Helmert translation were depracted since they are not used in the ITM - feel free to add them back from geotools if you need them! :-) )
 * 
 * @constructor 
 * @param {Number} dx
 * @param {Number} dy
 * @param {Number} dz
 */
JSITM.Translation = function(dx, dy, dz){
    this.dx = dx;
    this.dy = dy;
    this.dz = dz;
}

/**
 * Return a new translated Point. (Original point kept intact)
 *
 * @param {JSITM.Point} point original point.
 * @return {JSITM.Point}
 */
JSITM.Translation.prototype.translate = function(point){
    return new JSITM.Point(point.x + this.dx, point.y + this.dy, point.z + this.dz);
}

/**
 * Returns an new Translation with inverse values.
 * @return {JSITM.Translation}
 */
JSITM.Translation.prototype.inverse = function(){
    return new JSITM.Translation(-this.dx, -this.dy, -this.dz);
}

/**************************************************************/

/**
 * Creates a new Ellipsoid.<p>
 * for more info see <a href="http://en.wikipedia.org/wiki/Reference_ellipsoid">http://en.wikipedia.org/wiki/Reference_ellipsoid</a>
 *
 * @constructor
 * @param {Number} a length of the equatorial radius (the semi-major axis) in meters
 * @param {Number} b length of the polar radius (the semi-minor axis) in meters
 */
JSITM.Ellipsoid = function(a, b){
    this.a = a;
    this.b = b;
    
    // Compute eccentricity squared
    this.e2 = (Math.pow(a, 2) - Math.pow(b, 2)) / Math.pow(a, 2);
    
}

/**************************************************************/

/**
 * Creates a new LatLng containing an angular representation of a cartesian Point on the surface of the Ellipsoid.
 *
 * @param {JSITM.Point} point
 * @return {JSITM.LatLng}
 */
JSITM.Ellipsoid.prototype.pointToLatLng = function(point){

    var RootXYSqr = Math.sqrt(Math.pow(point.x, 2) + Math.pow(point.y, 2));
    
    var radlat1 = Math.atan2(point.z, (RootXYSqr * (1 - this.e2)));
    
    do {
        var V = this.a / (Math.sqrt(1 - (this.e2 * Math.pow(Math.sin(radlat1), 2))));
        var radlat2 = Math.atan2((point.z + (this.e2 * V * (Math.sin(radlat1)))), RootXYSqr);
        if (Math.abs(radlat1 - radlat2) > 0.000000001) {
            radlat1 = radlat2;
        }
        else {
            break;
        }
    }
    while (true);
    
    var lat = radlat2 * (180 / Math.PI);
    var lng = Math.atan2(point.y, point.x) * (180 / Math.PI);
    
    return new JSITM.LatLng(lat, lng);
}

/**
 * Creates a new Point object containing a cartesian representation of an angular LatLng on the surface of the Ellipsoid.
 *
 * @param {JSITM.LatLng} latlng
 * @return {JSITM.Point}
 */
JSITM.Ellipsoid.prototype.latLngToPoint = function(latlng){
    // Convert angle measures to radians
    var radlat = latlng.lat * (Math.PI / 180);
    var radlng = latlng.lng * (Math.PI / 180);
    
    // Compute nu
    var V = this.a / (Math.sqrt(1 - (this.e2 * (Math.pow(Math.sin(radlat), 2)))));
    
    // Compute XYZ
    var x = (V + latlng.alt) * (Math.cos(radlat)) * (Math.cos(radlng));
    var y = (V + latlng.alt) * (Math.cos(radlat)) * (Math.sin(radlng));
    var z = ((V * (1 - this.e2)) + latlng.alt) * (Math.sin(radlat));
    
    return new JSITM.Point(x, y, z);
}

/**
 * Cretaes a new TM (Transverse Mercator Projection).<br>
 * For more info see <a href="http://en.wikipedia.org/wiki/Transverse_Mercator">http://en.wikipedia.org/wiki/Transverse_Mercator</a>
 *
 * @constructor
 * @param {JSITM.Ellipsoid} reference ellipsoid
 * @param {Number} e0 eastings of false origin in meters
 * @param {Number} n0 northings of false origin in meters
 * @param {Number} f0 central meridian scale factor
 * @param {Number} lat0 latitude of false origin in decimal degrees.
 * @param {Number} lng0 longitude of false origin in decimal degrees.
 */
JSITM.TM = function(ellipsoid, e0, n0, f0, lat0, lng0){
    //eastings (e0) and northings (n0) of false origin in meters; _
    //central meridian scale factor (f0) and _
    //latitude (lat0) and longitude (lng0) of false origin in decimal degrees.
    
    this.ellipsoid = ellipsoid;
    this.e0 = e0;
    this.n0 = n0;
    this.f0 = f0;
    this.lat0 = lat0;
    this.lng0 = lng0;
    
    this.radlat0 = lat0 * (Math.PI / 180);
    this.radlng0 = lng0 * (Math.PI / 180);
    
    this.af0 = ellipsoid.a * f0;
    this.bf0 = ellipsoid.b * f0;
    this.e2 = (Math.pow(this.af0, 2) - Math.pow(this.bf0, 2)) / Math.pow(this.af0, 2);
    this.n = (this.af0 - this.bf0) / (this.af0 + this.bf0);
    this.n2 = this.n * this.n; //for optimizing and clarity of Marc()
    this.n3 = this.n2 * this.n; //for optimizing and clarity of Marc()
    
}

/**
 * Compute meridional arc
 * @private
 * @param {Number} radlat latitude of meridian in radians
 * @return {Number}
 */
JSITM.TM.prototype.Marc = function(radlat){
    
    return (
		this.bf0 * (
			((1 + this.n + ((5 / 4) * this.n2) + ((5 / 4) * this.n3)) * (radlat - this.radlat0)) - 
			(((3 * this.n) + (3 * this.n2) + ((21 / 8) * this.n3)) * (Math.sin(radlat - this.radlat0)) * (Math.cos(radlat + this.radlat0))) + 
			((((15 / 8) * this.n2) + ((15 / 8) * this.n3)) * (Math.sin(2 * (radlat - this.radlat0))) * (Math.cos(2 * (radlat + this.radlat0)))) - 
			(((35 / 24) * this.n3) * (Math.sin(3 * (radlat - this.radlat0))) * (Math.cos(3 * (radlat + this.radlat0))))
		)
	);
		

}

/**
 * Returns the  initial value for Latitude in radians.
 * @private
 * @param {Number} y northings of point
 * @return {Number}
 */
JSITM.TM.prototype.InitialLat = function(y){
  
    var radlat1 = ((y - this.n0) / this.af0) + this.radlat0;

    var M = this.Marc(radlat1);
    
    var radlat2 = ((y - this.n0 - M) / this.af0) + radlat1;
    
    while (Math.abs(y - this.n0 - M) > 0.00001) {
        radlat2 = ((y - this.n0 - M) / this.af0) + radlat1;
        M = this.Marc(radlat2);
        radlat1 = radlat2;
    }
    return radlat2;
}

/**
 * Un-project Transverse Mercator eastings and northings back to latitude and longtitude.
 * 
 * @param {JSITM.Point} point
 * @return {JSITM.LatLng} latitude and longtitude on the refernced ellipsoid's surface
 */

JSITM.TM.prototype.unproject = function(point){
    //
    //Input: - _
    
    //Compute Et
    var Et = point.x - this.e0;
    
    //Compute initial value for latitude (PHI) in radians
    var PHId = this.InitialLat(point.y);
    
    //Compute nu, rho and eta2 using value for PHId
    var nu = this.af0 / (Math.sqrt(1 - (this.e2 * (Math.pow(Math.sin(PHId), 2)))));
    var rho = (nu * (1 - this.e2)) / (1 - (this.e2 * Math.pow(Math.sin(PHId), 2)));
    var eta2 = (nu / rho) - 1;
    
    //Compute Latitude
    var VII = (Math.tan(PHId)) / (2 * rho * nu);
    var VIII = ((Math.tan(PHId)) / (24 * rho * Math.pow(nu, 3))) * (5 + (3 * Math.pow(Math.tan(PHId), 2)) + eta2 - (9 * eta2 * (Math.pow(Math.tan(PHId), 2))));
    var IX = (Math.tan(PHId) / (720 * rho * Math.pow(nu, 5))) * (61 + (90 * Math.pow(Math.tan(PHId), 2)) + (45 * (Math.pow(Math.tan(PHId), 4))));
    
    var lat = (180 / Math.PI) * (PHId - (Math.pow(Et, 2) * VII) + (Math.pow(Et, 4) * VIII) - (Math.pow(Et, 6) * IX));
    
    //Compute Longitude
    var X = (Math.pow(Math.cos(PHId), -1)) / nu;
    var XI = ((Math.pow(Math.cos(PHId), -1)) / (6 * Math.pow(nu, 3))) * ((nu / rho) + (2 * (Math.pow(Math.tan(PHId), 2))));
    var XII = ((Math.pow(Math.cos(PHId), -1)) / (120 * Math.pow(nu, 5))) * (5 + (28 * (Math.pow(Math.tan(PHId), 2))) + (24 * (Math.pow(Math.tan(PHId), 4))));
    var XIIA = ((Math.pow(Math.cos(PHId), -1)) / (5040 * Math.pow(nu, 7))) * (61 + (662 * (Math.pow(Math.tan(PHId), 2))) + (1320 * (Math.pow(Math.tan(PHId), 4))) + (720 * (Math.pow(Math.tan(PHId), 6))));
    
    var lng = (180 / Math.PI) * (this.radlng0 + (Et * X) - (Math.pow(Et, 3) * XI) + (Math.pow(Et, 5) * XII) - (Math.pow(Et, 7) * XIIA));
    
    var latlng = new JSITM.LatLng(lat, lng);
    
    return (latlng);
}


/**
 * Project Latitude and longitude to Transverse Mercator coordinates
 * @param {JSITM.LatLng} latitude and longtitude  to convert
 * @return {JSITM.Point} projected coordinates 
 */
JSITM.TM.prototype.project = function(latlng){
    // Convert angle measures to radians
    var RadPHI = latlng.lat * (Math.PI / 180);
    var RadLAM = latlng.lng * (Math.PI / 180);
    
    var nu = this.af0 / (Math.sqrt(1 - (this.e2 * Math.pow(Math.sin(RadPHI), 2))));
    var rho = (nu * (1 - this.e2)) / (1 - (this.e2 * Math.pow(Math.sin(RadPHI), 2)));
    var eta2 = (nu / rho) - 1;
    var p = RadLAM - this.radlng0;
    var M = this.Marc(RadPHI);
    
    var I = M + this.n0;
    var II = (nu / 2) * (Math.sin(RadPHI)) * (Math.cos(RadPHI));
    var III = ((nu / 24) * (Math.sin(RadPHI)) * (Math.pow(Math.cos(RadPHI), 3))) * (5 - (Math.pow(Math.tan(RadPHI), 2)) + (9 * eta2));
    var IIIA = ((nu / 720) * (Math.sin(RadPHI)) * (Math.pow(Math.cos(RadPHI), 5))) * (61 - (58 * (Math.pow(Math.tan(RadPHI), 2))) + (Math.pow(Math.tan(RadPHI), 4)));
    
    var y = I + (Math.pow(p, 2) * II) + (Math.pow(p, 4) * III) + (Math.pow(p, 6) * IIIA);
    
    var IV = nu * (Math.cos(RadPHI));
    var V = (nu / 6) * (Math.pow(Math.cos(RadPHI), 3)) * ((nu / rho) - (Math.pow(Math.tan(RadPHI), 2)));
    var VI = (nu / 120) * (Math.pow(Math.cos(RadPHI), 5)) * (5 - (18 * (Math.pow(Math.tan(RadPHI), 2))) + (Math.pow(Math.tan(RadPHI), 4)) + (14 * eta2) - (58 * (Math.pow(Math.tan(RadPHI), 2)) * eta2));
    
    var x = this.e0 + (p * IV) + (Math.pow(p, 3) * V) + (Math.pow(p, 5) * VI);
    
    return new JSITM.Point(x, y, 0)
}

/** Juicy part 1 ***************************************************************************/

/**
 * Ellipsoid for GRS80 (The refernce ellipsoid of ITM
 * @see http://en.wikipedia.org/wiki/GRS80
 * @type JSITM.Ellipsoid
 */
JSITM.GRS80 = new JSITM.Ellipsoid(6378137, 6356752.31414); 

/**
 * Ellipsoid for WGS84 (Used by GPS)
 * @see http://en.wikipedia.org/wiki/WGS80
 * @type JSITM.Ellipsoid
 */
JSITM.WGS84 = new JSITM.Ellipsoid(6378137, 6356752.314245);

/**
 * Simple Translation from GRS80 to WGS84
 * @see http://spatialreference.org/ref/epsg/2039/
 * @type JSITM.Translation
 */
JSITM.GRS80toWGS84 = new JSITM.Translation(-48, 55, 52); 

/**
 * Translation back from WGS84 to GRS80
 * @type JSITM.Translation
 */
JSITM.WGS84toGRS80 = JSITM.GRS80toWGS84.inverse();

/**
 * ITM (Israel Transverse Mercator) Projection 
 * @see http://en.wikipedia.org/wiki/Israeli_Transverse_Mercator
 * @type JSITM.TM
 */
JSITM.ITM = new JSITM.TM(JSITM.GRS80, 219529.58400, 626907.38999, 1.000006700000000, 31.734394, 35.204517);


/** Juicy part 2 ***************************************************************************/

/**
 * Converts a point to an ITM reference.
 * 
 * @example 
 *   JSITM.point2ItmRef(new JSITM.Point(200, 500)); // prints "200000500000"
 *   JSITM.point2ItmRef(new JSITM.Point(200, 500), 3); // prints "200500"
 * @param {JSITM.Point} point
 * @param {Number} precision 3=km, 4=100 meter, 5=decameter 6=meter.  optional, default is 6,
 * @return {String}
 */
JSITM.point2ItmRef = function(point, precision){

	function zeropad(num, len){
	    var str = new String(num);
	    while (str.length < len) {
	        str = '0' + str;
	    }
	    return str;
	}
	
	var p = precision || 6; 

    if (p < 3) 
        p = 3;
    if (p > 6) 
        p = 6;
    
    var div = Math.pow(10, (6 - p));
    var east = Math.round(point.x / div);
    var north = Math.round(point.y / div);
    return zeropad(east, p) + ' ' + zeropad(north, p);
	
}

/**
 * Parses an ITM reference and returns a Point object.<p>
 * throws an exception for invalid refernce!<p>
 * <p>
 * @example valid inputs:
 *  200500
 *  20005000
 *  2000000500000
 *  130:540
 *  131550:44000
 *  131 400
 *  210222 432111
 * 
 * @param {String} s
 * @return {JSITM.Point}
 */
JSITM.itmRef2Point = function(s){
    
    var precision;
    
    for (precision = 6; precision >= 3; precision--) {
        var pattern = new RegExp("^(\\d{" + precision + "})\\s*:?\\s*(\\d{" + precision + "})$", "i")
        var ref = s.match(pattern);
        if (ref) {
            if (precision > 0) {
                var mult = Math.pow(10, 6 - precision);
                var x = parseInt(ref[1], 10) * mult;
                var y = parseInt(ref[2], 10) * mult;
                return new JSITM.Point(x, y);
            }
        }
    }
    
	throw "Could not parse reference";
}


/** Juicy part 3 ***************************************************************************/

/**
 * Converts a Point on ITM to a LatLng on GPS 
 * @param {JSITM.Point} point
 * @return {JSITM.LatLng}
 */
JSITM.itm2gps = function(point){
    var latlng = this.ITM.unproject(point); //however, latlng is still on GRS80!
    return latlng.convertGrid(this.GRS80, this.WGS84, this.GRS80toWGS84);
}

/**
 * Converts a LatLng on GPS to a Point on ITM
 * @param {JSITM.LatLng} latlng
 * @return {JSITM.Point}
 */

JSITM.gps2itm = function(latlng){
    var wgs84 = latlng.convertGrid(this.WGS84, this.GRS80, this.WGS84toGRS80); //first convert to GRS80
    return this.ITM.project(wgs84);
}

/** Juicy part 4 ***************************************************************************/

/**
 * Converts an ITM grid refernece in 6, 8, 10 or 12 digits to a GPS angular Point instace
 * @param {String} s
 * @return {JSITM.Point}
 */
JSITM.itmRef2gps = function(s){
	var point = this.itmRef2Point(s);
	return this.itm2gps(point);
}

/**
 * Converts an ITM grid refernece in 6, 8, 10 or 12 digits to a GPS angular reference
 * @param {String} s
 * @return {String}
 */
JSITM.itmRef2gpsRef = function(s){
	return this.itmRef2gps(s).toString();
}

/**
 * Converts a GPS angular reference to an ITM LatLng instance
 * @param {String} s
 * @return {JSITM.LatLng} 
 */

JSITM.gpsRef2itm = function(s){
	var latlng = this.latlngFromString(s);
	return this.gps2itm(latlng);
}

/**
 * Converts a GPS angular reference to an ITM grid refernece in 6, 8, 10 or 12 digits
 * @param {String} s
 * @param {Number} precision 3=km, 4=100 meter, 5=decameter 6=meter. Optional.  Default value is 6=meter
 * @return {String} 
 */

JSITM.gpsRef2itmRef = function(s, precision){
	return this.point2ItmRef(this.gpsRef2itm(s), precision || 6);
}

       var res;

       //var my_token = "5a4b8472-b95b-4687-8179-0ccb621c7990"; //for localhost domain
       var my_token ='aafedfe5-8dfa-4fd5-9af9-8b95759447bd'; // my github
       //var my_token = "0fff9694-a045-4ede-b997-ee9927b0d56c";
       //var my_token:  "34280469-d493-4041-95e5-664f7fec6daf"; trillium
       $(document).ready(function ()
       {
           govmap.createMap('map', 
               {
                   token:  my_token,
                   showXY: true,
                   layers: ["BLDG_risk", "sites_muchrazim_test", "sites_tamaheyter_test", "T413", "ADD_PROJECTS_UR_MUCHRAZ", "SCHOOL"],
                   visibleLayers: ["BLDG_risk"],
                   layersMode: 2,
                   identifyOnClick: true,
                   isEmbeddedToggle: false,
                   background: 0,
                   layersMode: 1
               });

           if (isMobile()){
               appVue.mobile = true;
           }
       });

       var s_wkts = [];
       var s_names = [];
       var s_symbols = [];
       var bubbleHTMLParameters_all = [];

       var s_wkts_layer = [];
       var s_names_layer = [];
       var bubbleHTMLParameters_all_layer = [];
       var s_symbols_layer = [];
     
 
     function isMobile() {
         var match = window.matchMedia || window.msMatchMedia;
         if(match) {
             var mq = match("(pointer:coarse)");
             return mq.matches;
         }
         return false;
     }
     var lo_el;
     function getHeight()
     {
         var height =  $(document).height()/2.7;
         if (isMobile())
         {
             //console.log("mobile");
             height =  $(document).height() / 0.8;
             lo_el = document.getElementById("table-v-layout");
             lo_el.style.maxHeight = "90vh";
 
         }
         return height;
     }

         $.ajax({
             dataType: 'json',
             beforeSend : function() { 
                 //console.log("sending...");
             },
             success: function(json_data) {
                 {
                   if (json_data.length > 0)
                   {
                       for (i = 0; i < json_data.length; i++)
                       {
                           appVue.bldg_features.push(json_data[i]);
                       }
                       appVue.myloadingvariable = false;

  
                       //console.log("done");
                   }
                 }
                 
             },
             error : function(jqXHR, textStatus, errorThrown) {
                 //console.log("Error occurred: " + errorThrown);
             },
             url: 'https://www.govmap.gov.il/sites/bldg_risk.json'
         });
     

 
     var appVue = new Vue({
       el: '#app',
       vuetify: new Vuetify(),
       data () {
       return {
            addr: "",
           strviewUrl: "",
           gsv_dialog: false,
           snackbar: false,
           strview_snackbar: false,
           maxyear_rules: [v => v <= 1985 || 'שנת בניה מקסימלית 1985'],
           minyear_rules: [v => v >= 1900 || 'שנת בניה מינימלית 1900'],
           mobile: false,
           min_year: null,
           max_year: null,
           min_floor: null,
           max_floor: null,
         selected: null,
         dialog: false,
         page: 1,
         pageCount: 0,
         itemsPerPage: 2500,
         search: '',
         headers: [
         { text: 'מזהה', value: 'UNIQ_ID' },
         { text: 'שם ישוב', value: 'SETL_NAME' },
         { text: 'שם רחוב', value: 'STR_NAME' },
         { text: 'מספר בית', value: 'HOUSE_NUM'},
         { text: 'מספר דירות', value: 'AppCount'},
         { text: 'מספר קומות', value: 'BuildingFloors'},
         { text: 'שנת בניה', value: 'BuildingYear'},
         { text: 'גוגל מפות', value: 'action' }  
         ],


         options: [
{ text: 'אבו גוש', value: 472 },
{ text: 'אבו סנאן', value: 473 },
{ text: 'אבן יהודה', value: 182 },
{ text: 'אום אל-פחם', value: 2710 },
{ text: 'אופקים', value: 31 },
{ text: 'אור יהודה', value: 2400 },
{ text: 'אור עקיבא', value: 1020 },
{ text: 'אזור', value: 565 },
{ text: 'אחוזת ברק', value: 1330 },
{ text: 'אחיטוב', value: 850 },
{ text: 'אילת', value: 2600 },
{ text: 'אכסאל', value: 478 },
{ text: 'אליכין', value: 41 },
{ text: 'אלעד', value: 1309 },
{ text: 'אלפי מנשה', value: 3750 },
{ text: 'אלקנה', value: 3560 },
{ text: 'אפרת', value: 3650 },
{ text: 'אריאל', value: 3570 },
{ text: 'אשדוד', value: 70 },
{ text: 'אשקלון', value: 7100 },
{ text: 'באר יעקב', value: 2530 },
{ text: 'באר שבע', value: 9000 },
{ text: 'בוסתן הגליל', value: 559 },
{ text: 'בית אל', value: 3574 },
{ text: 'בית אלפא', value: 95 },
{ text: 'בית אריה', value: 3652 },
{ text: 'בית דגן', value: 466 },
{ text: 'בית ינאי', value: 200 },
{ text: 'בית יצחק-שער חפר', value: 326 },
{ text: 'בית שאן', value: 9200 },
{ text: 'בית שמש', value: 2610 },
{ text: 'ביתר עילית', value: 3780 },
{ text: 'בני ברק', value: 6100 },
{ text: 'בני עי"ש', value: 1066 },
{ text: 'בנימינה-גבעת עדה', value: 9800 },
{ text: 'בת חפר', value: 1319 },
{ text: 'בת ים', value: 6200 },
{ text: 'גבעת אבני', value: 1293 },
{ text: 'גבעת אלה', value: 1288 },
{ text: 'גבעת זאב', value: 3730 },
{ text: 'גבעת יערים', value: 787 },
{ text: 'גבעת שמואל', value: 681 },
{ text: 'גבעתיים', value: 6300 },
{ text: 'גדרה', value: 2550 },
{ text: 'גונן', value: 852 },
{ text: 'גינוסר', value: 262 },
{ text: 'גן יבנה', value: 166 },
{ text: 'גן נר', value: 1274 },
{ text: 'גני תקווה', value: 229 },
{ text: 'געתון', value: 463 },
{ text: 'דאלית אל-כרמל', value: 494 },
{ text: 'דימונה', value: 2200 },
{ text: 'הוד השרון', value: 9700 },
{ text: 'הר אדר', value: 3769 },
{ text: 'הרצלייה', value: 6400 },
{ text: 'זכרון יעקב', value: 9300 },
{ text: 'זרזיר', value: 975 },
{ text: 'חבצלת השרון', value: 235 },
{ text: 'חדרה', value: 6500 },
{ text: 'חולון', value: 6600 },
{ text: 'חופית', value: 115 },
{ text: 'חיבת ציון', value: 219 },
{ text: 'חיפה', value: 4000 },
{ text: 'חפץ חיים', value: 363 },
{ text: 'חצור-אשדוד', value: 406 },
{ text: 'חצור הגלילית', value: 2034 },
{ text: 'חריש', value: 1247 },
{ text: 'חשמונאים', value: 3770 },
{ text: 'טבריה', value: 6700 },
{ text: 'טורעאן', value: 498 },
{ text: 'טייבה', value: 2730 },
{ text: 'טירת כרמל', value: 2100 },
{ text: 'טל-אל', value: 1181 },
{ text: 'יבנה', value: 2660 },
{ text: 'יד נתן', value: 775 },
{ text: 'יהוד-מונוסון', value: 9400 },
{ text: 'יפיע', value: 499 },
{ text: 'יקנעם עילית', value: 240 },
{ text: 'ירוחם', value: 831 },
{ text: 'ירושלים', value: 3000 },
{ text: 'ירכא', value: 502 },
{ text: 'כוכב יאיר', value: 1224 },
{ text: 'כפר ברא', value: 633 },
{ text: 'כפר ורדים', value: 1263 },
{ text: 'כפר יונה', value: 168 },
{ text: 'כפר כמא', value: 508 },
{ text: 'כפר מנחם', value: 274 },
{ text: 'כפר מסריק', value: 297 },
{ text: 'כפר נטר', value: 316 },
{ text: 'כפר סבא', value: 6900 },
{ text: 'כפר קאסם', value: 634 },
{ text: 'כפר קרע', value: 654 },
{ text: 'כפר שמריהו', value: 267 },
{ text: 'כפר תבור', value: 47 },
{ text: 'כרמי יוסף', value: 1264 },
{ text: 'כרמיאל', value: 1139 },
{ text: 'לביא', value: 585 },
{ text: 'להבים', value: 1271 },
{ text: 'לוד', value: 7000 },
{ text: 'מבועים', value: 1080 },
{ text: 'מבשרת ציון', value: 1015 },
{ text: 'מגדל', value: 65 },
{ text: 'מגדל העמק', value: 874 },
{ text: 'מגשימים', value: 722 },
{ text: 'מודיעין-מכבים-רעות', value: 1200 },
{ text: 'מודיעין עילית', value: 3797 },
{ text: 'מוצא עילית', value: 208 },
{ text: 'מזכרת בתיה', value: 28 },
{ text: 'מזרעה', value: 517 },
{ text: 'מטולה', value: 43 },
{ text: 'מיתר', value: 1268 },
{ text: 'מכמורת', value: 382 },
{ text: 'מנחמיה', value: 48 },
{ text: 'מעלה אדומים', value: 3616 },
{ text: 'מעלות-תרשיחא', value: 1063 },
{ text: 'מענית', value: 344 },
{ text: 'מצפה רמון', value: 99 },
{ text: 'מרכז שפירא', value: 1098 },
{ text: 'משהד', value: 520 },
{ text: 'נהורה', value: 309 },
{ text: 'נהרייה', value: 9100 },
{ text: 'נווה ירק', value: 858 },
{ text: 'נופית', value: 1284 },
{ text: 'ניר עם', value: 348 },
{ text: 'ניר צבי', value: 331 },
{ text: 'נס ציונה', value: 7200 },
{ text: 'נצרת', value: 7300 },
{ text: 'נצרת עילית', value: 1061 },
{ text: 'נשר', value: 2500 },
{ text: 'נתיבות', value: 246 },
{ text: 'נתניה', value: 7400 },
{ text: 'סביון', value: 587 },
{ text: 'ספיר', value: 1176 },
{ text: 'עומר', value: 666 },
{ text: 'עילוט', value: 511 },
{ text: 'עין דור', value: 436 },
{ text: 'עין ורד', value: 157 },
{ text: 'עין יהב', value: 806 },
{ text: 'עכו', value: 7600 },
{ text: 'עמנואל', value: 3660 },
{ text: 'עפולה', value: 7700 },
{ text: 'עפרה', value: 3617 },
{ text: 'עץ אפרים', value: 3778 },
{ text: 'ערד', value: 2560 },
{ text: 'עשרת', value: 591 },
{ text: 'עתלית', value: 53 },
{ text: 'פוריידיס', value: 537 },
{ text: 'פקיעין (בוקייעה)', value: 536 },
{ text: 'פרדס חנה-כרכור', value: 7800 },
{ text: 'פרדסייה', value: 171 },
{ text: 'פתח תקווה', value: 7900 },
{ text: 'צוקי ים', value: 1102 },
{ text: 'צור הדסה', value: 1113 },
{ text: 'צפת', value: 8000 },
{ text: 'קדימה-צורן', value: 195 },
{ text: 'קורנית', value: 1179 },
{ text: 'קיסריה', value: 1167 },
{ text: 'קציר', value: 1243 },
{ text: 'קריית אונו', value: 2620 },
{ text: 'קריית ארבע', value: 3611 },
{ text: 'קריית אתא', value: 6800 },
{ text: 'קריית ביאליק', value: 9500 },
{ text: 'קריית גת', value: 2630 },
{ text: 'קריית ים', value: 9600 },
{ text: 'קריית יערים', value: 1137 },
{ text: 'קריית מוצקין', value: 8200 },
{ text: 'קריית מלאכי', value: 1034 },
{ text: 'קריית עקרון', value: 469 },
{ text: 'קריית שמונה', value: 2800 },
{ text: 'קרית טבעון', value: 2300 },
{ text: 'קרני שומרון', value: 3640 },
{ text: 'ראמה', value: 543 },
{ text: 'ראש העין', value: 2640 },
{ text: 'ראשון לציון', value: 8300 },
{ text: 'רחובות', value: 8400 },
{ text: 'ריינה', value: 542 },
{ text: 'רכסים', value: 922 },
{ text: 'רמות השבים', value: 206 },
{ text: 'רמלה', value: 8500 },
{ text: 'רמת גן', value: 8600 },
{ text: 'רמת השופט', value: 335 },
{ text: 'רמת השרון', value: 2650 },
{ text: 'רמת ישי', value: 122 },
{ text: 'רעננה', value: 8700 },
{ text: 'שבי ציון', value: 282 },
{ text: 'שבלי - אום אל-גנם', value: 913 },
{ text: 'שדרות', value: 1031 },
{ text: 'שוהם', value: 1304 },
{ text: 'שלומי', value: 812 },
{ text: 'שניר', value: 1132 },
{ text: 'שערי תקווה', value: 3720 },
{ text: 'שפרעם', value: 8800 },
{ text: 'שריגים (לי-און)', value: 1114 },
{ text: 'תל אביב -יפו', value: 5000 },
{ text: 'תל מונד', value: 154 },
{ text: 'תמרת', value: 1244 }
   ],

         bldg_features: [],
         selected_features: [],
         myloadingvariable: true,
       }
     },
     computed: {
         badge(){
             var res = false;
             if (this.selected_features.length > 0)
             {
                 res = true;
             }
             return res;
 
         }
     },
     methods: {
       handleClick(value) {
           //console.log(value.UNIQ_ID);
           //govmap.zoomToXY({ x: value.x, y: value.y, level: 10, marker: false });
           govmap.searchInLayer({ 'layerName': 'BLDG_risk', 'fieldName': 'UNIQ_ID', 'fieldValues': [value.UNIQ_ID], 'highlight': true });
       },
       close () {
           this.dialog = false;
       },
       save () {

           govmap.clearSelection();
           govmap.filterLayers({ 'layerName': "BLDG_risk", 'whereClause': "SETL_CODE = " + this.selected +" AND (BuildingYear BETWEEN "+ this.min_year + " AND " + this.max_year + ") AND (BuildingFloors BETWEEN " + this.min_floor + " AND " + this.max_floor +")", 'zoomToExtent': true });
           var newArray = appVue.options.filter(function(item) {
               return item.value == appVue.selected;
           });
           //console.log(newArray[0].text + "!!!!")
           if (newArray.length > 0){
               appVue.selected_features = appVue.bldg_features.filter(function(item) {
                   return (item.SETL_NAME == newArray[0].text) && (item.BuildingYear >= appVue.min_year && item.BuildingYear <= appVue.max_year) && (item.BuildingFloors >= appVue.min_floor && item.BuildingFloors <= appVue.max_floor) ;
               });
               if (appVue.selected_features.length == 0)
               {
                   //console.log("SFDF")
                   appVue.snackbar = true;
               }
           }



           this.dialog = false;
       },
       onChange(event) {
           //console.log(event)
           var newArray = appVue.options.filter(function(item) {
               return item.value == event;
           });

           if (newArray){
               //console.log(newArray[0].text);
               appVue.selected_features = appVue.bldg_features.filter(function(item) {
                   return item.SETL_NAME == newArray[0].text;
               });
               
               //govmap.filterLayers({ 'layerName': "BLDG_risk", 'whereClause': "SETL_CODE = " + event, 'zoomToExtent': true });
               govmap.searchInLayer({ 'layerName': 'BLDG_risk', 'fieldName': 'SETL_CODE', 'fieldValues': [event], 'highlight': true });

               //this.dialog = true;

               this.menu_btn = true;
           }
       },

       openStreetView(item){

        govmap.geocode({keyword: item.STR_NAME.replace('""', '"') + " " + item.HOUSE_NUM + " " + ", " + item.SETL_NAME.replace('""', '"')},govmap.geocodeType.FullResult)
					.then(function(response){
            //console.log(response);
            if (response.data){
              if (response.data[0].DescLayerID == "ADDR_V1")
              {
                x = response.data[0].X;
                y = response.data[0].Y;

                ////console.log(x, y);

                //console.log(JSITM.itmRef2gpsRef(parseInt(response.data[0].X, 10) + "" + parseInt(response.data[0].Y, 10)));
                var wgs84 = JSITM.itmRef2gpsRef(parseInt(response.data[0].X, 10) + "" + parseInt(response.data[0].Y, 10)).replace(" ", ",");
                appVue.addr = item.STR_NAME.replace('""', '"') + " " + item.HOUSE_NUM + " " + ", " + item.SETL_NAME.replace('""', '"');
                appVue.strviewUrl = "https://www.google.com/maps/embed/v1/streetview?key=AIzaSyBDU5RFJk1IDETKeGB0I5ycQu6NaUnLWqA&location="+wgs84+"&heading=210&pitch=10&fov=35";
                appVue.gsv_dialog = true;
              }
              else{
                appVue.strview_snackbar = true;

              }
              
            }
            else{
              appVue.strview_snackbar = true;

            }

          });
          

           ////console.log(item.StreetView.replace('++', '+'));
           //window.open(item.StreetView.replace('++', '+').replace(' -', ' '), '_blank').focus();

       },
       clear(){

           appVue.selected_features = [];
           appVue.selected = null;
           appVue.min_year = null;
           appVue.max_year= null;
           appVue.min_floor= null;
           appVue. max_floor= null;
           appVue.dialog= false;
           govmap.clearSelection();
           govmap.filterLayers({ 'layerName': "BLDG_risk", 'whereClause': "SETL_CODE > 0", 'zoomToExtent': true });

       }
     }
     })
 
     appVue.bldg_features = [];
   </script>






   
</body>

</html>
